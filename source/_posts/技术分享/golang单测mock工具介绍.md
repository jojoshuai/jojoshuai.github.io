---
title: golang单测mock工具介绍
date: 2024-09-18 10:42:17
categories:
  - 技术分享
tags:
  - golang
  - 单测
  - mock
---

[toc]

# golang 单测 mock 工具介绍

## 1. 背景

在项目中，常常会有依赖额外服务或组件的情况，而如果要对这些代码做单测，则

1. 要么保证单测执行时能正常访问这些服务，并且需要做好测试前的数据和测试后的数据清理。
2. 或者我们可以选择 mock 这些服务：
3. 方案 1:在本地起一个依赖的服务来处理依赖，例如起一个单机版 redis 等
4. 方案 2:替换函数 mock

否则，会导致 ci 流水线的失败，或者不够独立。

我们着重介绍 mock 的方案。

## 2. gomock

> https://github.com/golang/mock

### 2.1 使用流程

#### 2.1.1 待测试代码

```golang
// db.go
package ut

type DB interface { // 被mock的interface
   Get(key string) (int, error)
}

func GetFromDB(db DB, key string) int {  // 待测试函数
   if value, err := db.Get(key); err == nil {
      return value
   }

   return -1
}
```

#### 2.1.2 生成辅助测试代码

> 使用 mockgen 工具
> `mockgen -source=db.go -destination=db_mock.go -package=ut`

```golang
// db_mock.go
// Code generated by MockGen. DO NOT EDIT.
// Source: db.go

// Package ut is a generated GoMock package.
package ut

import (
   reflect "reflect"

   gomock "github.com/golang/mock/gomock"
)

// MockDB is a mock of DB interface.
type MockDB struct {
   ctrl     *gomock.Controller
   recorder *MockDBMockRecorder
}

// MockDBMockRecorder is the mock recorder for MockDB.
type MockDBMockRecorder struct {
   mock *MockDB
}

// NewMockDB creates a new mock instance.
func NewMockDB(ctrl *gomock.Controller) *MockDB {
   mock := &MockDB{ctrl: ctrl}
   mock.recorder = &MockDBMockRecorder{mock}
   return mock
}

// EXPECT returns an object that allows the caller to indicate expected use.
func (m *MockDB) EXPECT() *MockDBMockRecorder {
   return m.recorder
}

// Get mocks base method.
func (m *MockDB) Get(key string) (int, error) {
   m.ctrl.T.Helper()
   ret := m.ctrl.Call(m, "Get", key)
   ret0, _ := ret[0].(int)
   ret1, _ := ret[1].(error)
   return ret0, ret1
}

// Get indicates an expected call of Get.
func (mr *MockDBMockRecorder) Get(key interface{}) *gomock.Call {
   mr.mock.ctrl.T.Helper()
   return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "Get", reflect.TypeOf((*MockDB)(nil).Get), key)
}
```

#### 2.1.3 编写测试代码

```golang
// db_test.go
package ut

import (
   "errors"
   "testing"

   "github.com/golang/mock/gomock"
)

func TestGetFromDB(t *testing.T) {
   ctrl := gomock.NewController(t)
   defer ctrl.Finish() // 断言 DB.Get() 方法是否被调用

   // mock出db
   mockDB := NewMockDB(ctrl)
   mockDB.EXPECT().Get(gomock.Eq("Tom")).Return(100, errors.New("not exist"))

   // 将mockDB传入测试方法
   if v := GetFromDB(mockDB, "Tom"); v != -1 {
      t.Fatal("expected -1, but got", v)
   }
}
```

#### 2.1.4 测试结果

```
go test -v -run ^TestGetFromDB$

=== RUN   TestGetFromDB
--- PASS: TestGetFromDB (0.00s)
PASS
ok      jojoshuai/experiment/ut 0.049s

```

### 2.2 总结

- 使用依赖注入的方式，来 mock 依赖的 interface。
- 对被测试代码的写法有要求：被依赖性需要是传入的(即 依赖注入的)
- 写单测前：需要使用 mockgen 生成新依赖代码

## 3. gomonkey

> https://github.com/agiledragon/gomonkey 2k

### 3.1 使用流程

#### 3.1.1 待测试代码

```golang
package ut

func Foo(a string) string { // 待测试函数
   return Bar(a)
}

func Bar(a string) string {  // 被依赖函数
   return a
}
```

#### 3.1.2 编写测试代码

```golang
package ut

import (
   "testing"

   "github.com/agiledragon/gomonkey"
   "github.com/smartystreets/goconvey/convey"
)

func TestFooByMonkey(t *testing.T) {
   patches := gomonkey.ApplyFunc(Bar, func(a string) string {
      return "c"
   })
   defer patches.Reset()

   convey.Convey("test return", t, func() {
      r := Foo("a")
      convey.So(r, convey.ShouldEqual, "c")
   })
}
```

#### 3.1.3 测试结果

> 必须：禁止内联&编译优化
> 内联：为了减少函数调用时的堆栈等开销，对于简短的函数，会在编译时，直接内嵌调用的代码。

```
go test -gcflags="all=-l -N" -v -run ^TestFooByMonkey$
=== RUN   TestFooByMonkey

  test return ✔


1 total assertion

--- PASS: TestFooByMonkey (0.00s)
PASS
ok      jojoshuai/experiment/ut 0.052s
```

### 3.2 原理简述

获取被 mock 函数和 mock 函数运行时的地址，将被 mock 函数的地址替换为 mock 函数。

- 需要使用汇编来修改函数的地址，汇编语言跟硬件强相关，gomonkey 在兼容上做的不够好
- go 多协程运行时，也不能很好的处理多协程间函数替换的问题

### 3.3 总结

简单易用，可以处理大部分场景。

## 4. 引用

> 参考：https://bou.ke/blog/monkey-patching-in-go/

> [译文](https://berryjam.github.io/2018/12/golang%E6%9B%BF%E6%8D%A2%E8%BF%90%E8%A1%8C%E6%97%B6%E5%87%BD%E6%95%B0%E4%BD%93%E5%8F%8A%E5%85%B6%E5%8E%9F%E7%90%86/)
